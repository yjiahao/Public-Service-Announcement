import os

from app import app
from flask import request, abort, render_template, url_for, redirect
from sklearn.metrics.pairwise import cosine_similarity

import json

import pandas as pd
import numpy as np

from dotenv import load_dotenv

from sentence_transformers import SentenceTransformer

from langchain_openai import ChatOpenAI

load_dotenv()
os.environ["OPENAI_API_KEY"] = os.getenv('OPENAI_API_KEY')

# load pretrained encoding model, takes a while to load
model = SentenceTransformer('all-MiniLM-L6-v2')

# load the llm to help us rerank
llm = ChatOpenAI(model="gpt-4o-mini", temperature = 0)

# load dataset: should contain the embeddings generated by the model on the job description
jobs = pd.read_csv("data/preprocessed.csv")

@app.route("/", methods=["GET", "POST"])
def home():
    if request.method == "GET":
        return render_template("index.html")

    elif request.method == "POST":
        # User's input: should get from form here using request...
        interests = request.form.get("interests")
        skills = request.form.get("skills")
        certs = request.form.get("qualification")
        jobhist = request.form.get("exp")
        psa_courses = request.form.get("psatraining")
        job_preference = request.form.get("pref")

        # Combine inputs into one sentence
        sentence = f'''
        Interests: {interests},
        Skills: {skills},
        Certifications: {certs},
        Job History: {jobhist},
        PSA courses taken: {psa_courses},
        Job Preference: {job_preference}
        '''

        # Encode the sentence into an embedding vector
        embeddings = model.encode([sentence])  # Assuming this outputs a list or array
        embeddings = np.array(embeddings).reshape(1, -1)  # Reshape to (1, n_features)

        # Make a copy of the job data
        temp_df = jobs.copy()

        # Ensure job embeddings are numpy arrays and properly shaped
        temp_df['embeddings'] = temp_df['embeddings'].apply(lambda x: np.array(json.loads(x)).reshape(1, -1))

        # Compute cosine similarity
        temp_df['similarity_score'] = temp_df['embeddings'].apply(lambda x: cosine_similarity(x, embeddings)[0][0])

        # Sort by similarity score in descending order
        temp_df = temp_df.sort_values(by='similarity_score', ascending=False)

        # Serve top 10 results
        top_10_jobs = temp_df.head(10)

        # reranker goes here
        # interest, education, job history, skills, certifications, psa_course, job_preference
        # d = {
        #     "interest": interests,
        #     "education": certs,
        #     "job history": jobhist,
        #     "years of experience": 
        # }
        # temp = pd.DataFrame()

        recommendations = '''

        Top Three Job Recommendations:
        ------------------------------------------------------------
        Rank 1: Electrical Engineer (Power Infrastructure)
        Rating: 9/10
        Justification:
        The user holds a Bachelor of Engineering with Honours in Electrical Power Engineering, which aligns well with the job requirement of a degree in Electrical Engineering. With 14 years of experience as a Business Analyst, the user likely possesses transferable skills such as problem-solving and project management. However, the user may need to demonstrate relevant experience specifically in electrical infrastructure maintenance
        or design consultancy, as the job requires at least 2 years in this area. Additionally, obtaining the Professional Engineering certification or Licensed Electrical Worker (LEW) license would strengthen their application.
        
        Roadmap:
        1. Gain Relevant Experience: Seek opportunities to work on electrical infrastructure projects, either through current employment or by volunteering for relevant projects.
        2. Professional Certification: Pursue Professional Engineer (PE) certification, which may require passing exams and demonstrating relevant work experience.
        3. LEW License: Consider obtaining a Licensed Electrical Worker (LEW) license, which may involve specific training and examinations.
        4. Networking: Join professional associations related to electrical engineering to connect with industry professionals and stay updated on job opportunities.
        5. Continuing Education: Enroll in courses or workshops focused on high voltage systems, project management, or electrical infrastructure to enhance technical knowledge and skills.
        ------------------------------------------------------------

        Rank 2: Deputy Manager (Port Ecosystem Commercial)
        Rating: 7/10
        Justification:
        ** The user holds a Bachelor of Engineering with Honours in Electrical Power Engineering, which is a relevant degree that provides a strong technical background. While the job focuses on business development and customer management within the port ecosystem, the user’s
        experience as a Business Analyst and skills in technical expertise and software development may offer valuable insights into operational processes and analytics. However, the job requires strong sales and negotiation capabilities, which are not explicitly mentioned in the user’s background. Given the user’s qualifications and relevant experience, they would be a good fit for the role, but they may need to further develop specific sales and customer relationship management skills to excel.

        **
        Roadmap:
        **
        1. Sales Training: Enroll in a sales training program or workshop to develop negotiation and relationship-building skills.
        2. Certifications:
        - Acquire a certification in Business Development (e.g., Certified Business Development Expert).
        - Consider obtaining a certification in Supply Chain Management (e.g., APICS CPIM).
        3. Networking: Join industry-related groups or associations focused on logistics and supply chain management to expand the user’s professional network.
        4. Market Research: Engage in self-study or courses related to market research and competitive analysis to better understand trade flows and market intel.
        5. Soft Skills Development: Work on enhancing communication, presentation, and interpersonal skills through workshops or practice in professional settings.
        6. Industry Knowledge: Stay updated with industry trends in port management and logistics, potentially through webinars, journals, or courses focused on these areas. 

        By following this roadmap, the user can strengthen their profile for the Deputy Manager position and align more closely with the job's requirements.
        ------------------------------------------------------------
        '''
        return redirect(url_for("results", recommendations = recommendations))
    else:
        abort(400, description="Request method not supported")

@app.route("/results")
def results():
    recommendations = request.args.get("recommendations")
    return render_template("results.html", recommendations = recommendations)